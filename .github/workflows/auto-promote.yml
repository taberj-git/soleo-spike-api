name: Auto-promote Dev to Main

# Trigger options - choose one or combine:
on:
  # Option 1: Manual trigger
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for promoting to main'
        required: false
        default: 'Scheduled promotion'

  # Option 2: Schedule (every Sunday at midnight UTC)
  schedule:
    - cron: '0 0 * * 0'

  # Option 3: When a release tag is created
  # push:
  #   tags:
  #     - 'v*.*.*'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-promotion-pr:
    name: Create PR from Dev to Main
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if dev is ahead of main
        id: check-diff
        run: |
          git fetch origin main:main
          COMMITS_AHEAD=$(git rev-list --count main..dev)
          echo "commits_ahead=$COMMITS_AHEAD" >> $GITHUB_OUTPUT

          if [ "$COMMITS_AHEAD" -eq "0" ]; then
            echo "No new commits to promote from dev to main"
            echo "should_create_pr=false" >> $GITHUB_OUTPUT
          else
            echo "Dev is $COMMITS_AHEAD commits ahead of main"
            echo "should_create_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-diff.outputs.should_create_pr == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitsAhead = '${{ steps.check-diff.outputs.commits_ahead }}';
            const reason = '${{ github.event.inputs.reason || 'Scheduled promotion' }}';

            // Get list of commits
            const commits = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'main',
              head: 'dev'
            });

            // Build PR body
            let prBody = `## ðŸš€ Promotion from Dev to Main\n\n`;
            prBody += `**Reason:** ${reason}\n\n`;
            prBody += `**Commits to be merged:** ${commitsAhead}\n\n`;
            prBody += `### Changes\n\n`;

            commits.data.commits.forEach(commit => {
              const message = commit.commit.message.split('\n')[0];
              const sha = commit.sha.substring(0, 7);
              prBody += `- ${sha} ${message}\n`;
            });

            prBody += `\n### Merge Instructions\n\n`;
            prBody += `This PR will automatically merge to main after:\n`;
            prBody += `1. âœ… All CI/CD checks pass\n`;
            prBody += `2. âœ… PR is labeled with \`auto-merge\` (if desired)\n\n`;
            prBody += `Or merge manually if you prefer.\n\n`;
            prBody += `ðŸ¤– Generated by GitHub Actions`;

            // Check if PR already exists
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:dev`,
              base: 'main'
            });

            if (existingPRs.data.length > 0) {
              console.log(`PR already exists: #${existingPRs.data[0].number}`);
              console.log('Updating existing PR...');

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: existingPRs.data[0].number,
                body: prBody
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingPRs.data[0].number,
                body: `ðŸ”„ Updated promotion PR with ${commitsAhead} new commits from dev.`
              });

              return;
            }

            // Create new PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš€ Promote Dev to Main (${commitsAhead} commits)`,
              head: 'dev',
              base: 'main',
              body: prBody,
              maintainer_can_modify: true
            });

            console.log(`âœ… Created PR #${pr.data.number}`);

            // Optionally add auto-merge label
            // await github.rest.issues.addLabels({
            //   owner: context.repo.owner,
            //   repo: context.repo.repo,
            //   issue_number: pr.data.number,
            //   labels: ['auto-merge']
            // });

      - name: Summary
        if: steps.check-diff.outputs.should_create_pr == 'true'
        run: |
          echo "âœ… Created or updated promotion PR from dev to main"
          echo "Commits to merge: ${{ steps.check-diff.outputs.commits_ahead }}"
